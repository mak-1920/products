{% extends 'base.html.twig' %}

{% block title %}Csv import{% endblock %}

{% block body %}

<div class="wrapper">
    {{ form_start(form, { 'attr': {'novalidate' : 'novalidate'} }) }}
        {{ form_row(form.file) }}
        <div id="prototype" data-prototype="{{ form_widget(form.csvSettings.vars.prototype)|e }}"></div>
        <div class="csv-sets"></div>
        {{ form_row(form.import) }}
        {{ form_row(form._token) }}
    {{ form_end(form, { 'render_rest': false }) }}

    {% if ids|length > 0 %}
        <p>Files have been uploaded and will be processed!</p>
        <div>
            IDs of requests:
            <ul class="import-result-ids">
                {% for id in ids %}
                    <li>id{{ id }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="import-send-result"></div>
    {% endif %}
</div>

<script {#id="mercure-import-send-url"#}>
    const eventSource = new EventSource("{{ mercure('/import/send/{id}')|escape('js') }}");
    eventSource.onmessage = event => {
        console.log(JSON.parse(event.data));
    }
{#    {{ mercure('/import/send/___id___')|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG'))|raw }};#}
</script>
{% endblock %}
